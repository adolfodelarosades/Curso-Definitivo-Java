# 20201120 Viernes

## Documento Relaciones Entre Entidades.

[Documento Relaciones Entre Entidades](https://github.com/adolfodelarosades/Java/blob/master/temarios/000_592_DESARROLLADOR_JAVA_EE_FRONT_END_MULTIPLATAFORMA/pdfs/relacion_entre_Entidades.pdf)

## Relaciones Muchos a Muchos

Esta relación se da cuando una Entidad esta asociados a muchos objetos de otra Entidad y viceversa. Por ejemplo una Cuenta puede pertenecer a varios Clientes y un Cliente puede tener varias Cuentas.

![20201120-01](images/20201120-01.png)

A nivel de BD una relación Muchos a Muchos necesita una tabla intermedia para crear esta relación en este caso le llamamos Titulares. No hay una relación directa entre Cuentas y Clientes se necesita una tabla intermedia que tenga la combinación de las Foreing Keys. Realmente en la BD tenemos una Relación Uno a Muchos entre Cuentas y Titutulares y otra Relación Uno a Muchos entre Clientes y titulares.

Normalmente la tabla de Join (Titulares) no contiene más que los campos de las Foreing Keys. La existencia de la tabla de Join permite modelar una relación Muchos a Muchos sin tener encuenta la tabla Join, es decir la tabla existe pero al generar las Entidades la de esta tabla se omite solo las dos principales contaran con su Entidad.

Si la tabla de Join cuenta con más campos además de las Foreing Keys más vale tener una Relación Uno a Muchos y Muchos a Uno.

En este caso cuando generemos las Entidades Cuentas va a contra con sus atributos y además una  lista de Clientes y en el caso de la Entidad Clientes va a contar con sus atributos y además un atributo con la lista de Cuentas, anotados con `@ManytoMany`.

Como ambas tablas van a ser Muchos en alguna de ellas la debemos denotar como propietaria, una vez elegida una de las dos la vamos a anotar con `@JoinTable` donde vamos a informar sobre la tabla intermedia (Titulares) para ver como se relaciona con las otras dos tablas. `@JoinTable` tiene los siguientes atributos:

* `name`: Indicamos el nombre de la tabla intermedia
* `joinColumns` e `inverseJoinColumns` Con estos atributos indicamos los campos
de relación entre la tabla de join las tablas propietarias e inversa, respectivamente. El valor de cada uno de estos atributos es una anotación `@JoinColumn` con dos atributos:
   * `name`. Nombre de la columna en la tabla de join
   * `referencedColumnName`. Nombre de la columna en la tabla principal.

La que no es propietaria va a llevar el `@ManytoMany(mapperBy="cuentas")` que indica en que campo de la otra Entidad va a tener la información de la relación.

En nuestro ejemplo, el atributo cuentas de la entidad Cliente debería estar definido de la siguiente manera:

```java
@ManyToMany @JoinTable(name="Titulares",
     joinColumns=@JoinColumn(name="idCliente",referencedColumnName="dni"),
     inverseJoinColumns=@JoinColumn(name="idCuenta",
     referencedColumnName="numeroCuenta"))
private List<Cuenta> cuentas;
```

***EL ASISTENTE NO NOS LLENA ESTA PARTE HAY QUE HACERLO MANUALMENTE***

Los JOINs Explícitos nos van a servir para recuprar la información en las Relaciones Muchos a Muchos.

```java
SELECT c FROM Cliente c JOIN c.cuentas b WHERE b.saldo > 1000
```

La tabla intermedia no pinta nada a nivel de Entidades por lo que en JPQL es como si no existiera.

## Base de Datos `bancabd`

Contamos con la BD `bancabd` con las siguientes tablas.

![20201120-01](images/20201120-01.png)

Tenemos una relación entre Clientes a Titutulares, de Titulares a Cuentas y Otra de Cuentas a Movimimientos.

Si queremos generar un Modelo Muchos a Muchos de esta BD 
¿Cuántas Entidades se Generarian? 3 Clientes, Cuentas y Movimientos.
¿Cuantas Relaciones? 2. Una Muchos a Muchos y otra Uno a Muchos.

***A nivel de código es mejor plantearse una relación Muchos a Muchos en lugar de una Uno a Muchos - Muchos a Uno*** Salvo que titulares tuviera más información que las Foreing Keys, como la tabla de Matriculas de los ejemplos anteriores.

## :computer: `09_cajero_virtual` Relación Muchos A Muchos

### 01. Mavenizar el Proyecto y Meter las Dependencias 

`pom.xml`

```html
<dependencies>
  	<!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
	<dependency>
	    <groupId>mysql</groupId>
	    <artifactId>mysql-connector-java</artifactId>
	    <version>8.0.19</version>
	</dependency>
  	<!-- https://mvnrepository.com/artifact/org.springframework/spring-core -->
	<dependency>
	    <groupId>org.springframework</groupId>
	    <artifactId>spring-core</artifactId>
	    <version>5.2.9.RELEASE</version>
	</dependency>
	<!-- https://mvnrepository.com/artifact/org.springframework/spring-context -->
	<dependency>
	    <groupId>org.springframework</groupId>
	    <artifactId>spring-context</artifactId>
	    <version>5.2.9.RELEASE</version>
	</dependency>
	<dependency>
	    <groupId>org.springframework</groupId>
	    <artifactId>spring-web</artifactId>
	    <version>5.2.9.RELEASE</version>
	</dependency> 
  	<dependency>
	    <groupId>org.springframework</groupId>
	    <artifactId>spring-orm</artifactId>
	    <version>5.2.9.RELEASE</version>
	</dependency>
	<dependency>
	    <groupId>org.hibernate</groupId>
	    <artifactId>hibernate-core</artifactId>
	    <version>5.4.18.Final</version>
	</dependency>
  </dependencies>
```

### 02. Poner Características JPA para poder usar el Asistente

![09-01-s-ej](images/09-01-s-ej.png)
![09-02-s-ej](images/09-02-s-ej.png)

### 03. Generar Entidades con el Asistente.

![09-03-s-ej](images/09-03-s-ej.png)

Debemos hacer una conexión para esta BD que no habíamos usado, usando el Driver de MySql 5.

![09-04-s-ej](images/09-04-s-ej.png)
![09-05-s-ej](images/09-05-s-ej.png)
![09-06-s-ej](images/09-06-s-ej.png)
![09-07-s-ej](images/09-07-s-ej.png)

Una vez realizada la conexión a la BD ya la podemos seleccionar y nos salen sus tablas.

![09-08-s-ej](images/09-08-s-ej.png)

Selecciono las Tablas de las que queremos generar Entidades.

![09-09-s-ej](images/09-09-s-ej.png)

En la siguiente pantalla vamos a meter las Relaciones que como hemos visto son dos.

![09-10-s-ej](images/09-10-s-ej.png)

Empezamos con la relación Uno a Muchos entre Cuentas y Movimientos.

![09-11-s-ej](images/09-11-s-ej.png)

En la Siguiente pantalla indicamos los campos de la Relación

![09-12-s-ej](images/09-12-s-ej.png)

Cada Cuenta va a tener muchos Movimientos

![09-13-s-ej](images/09-13-s-ej.png)

Ya tenemos nuestra primer Relación

![09-14-s-ej](images/09-14-s-ej.png)

















