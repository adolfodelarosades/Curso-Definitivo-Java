# 20201106 Viernes

### :computer: Ejemplo `04_buscador`

Vamos a realizar una aplicacíon "Mini Google" que busque ciertos temas y muestre enlaces a direcciones Web relacionadas con lo buscado.

![04-01-02-ej](images/04-01-02-ej.png)

La aplicación va a tener un HTML y un Servlet.

`buscador.html`

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Buscador</title>
</head>
<body>
   <div align="center">
      <h1>Buscador</h1>
      <form action="Buscador" method="post">
         Introduce tema de búsqueda:<input type="text" name="tema"/> 
         <input type="submit" value="Buscar"/>
      </form>
   </div>
</body>
</html>
```

`Item.java`

```java
package model;

public class Item {
   private String titulo;
   private String url;
   private String[] seo;
   private String descripcion;
	
   public Item(String titulo, String url, String[] seo, String descripcion) {
      super();
      this.titulo = titulo;
      this.url = url;
      this.seo = seo;
      this.descripcion = descripcion;
   }
	
   public String getTitulo() {
      return titulo;
   }
   public void setTitulo(String titulo) {
      this.titulo = titulo;
   }
   public String getUrl() {
      return url;
   }
   public void setUrl(String url) {
      this.url = url;
   }
   public String[] getSeo() {
      return seo;
   }
   public void setSeo(String[] seo) {
      this.seo = seo;
   }
   public String getDescripcion() {
      return descripcion;
   }
   public void setDescripcion(String descripcion) {
      this.descripcion = descripcion;
   }
	
}
```

`Buscador.java`

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import model.Item;

/**
 * Servlet implementation class Buscador
 */
@WebServlet("/Buscador")
public class Buscador extends HttpServlet {
	
   private static final long serialVersionUID = 1L;
	
   List<Item> items=List.of(
      new Item("Casa del libro","http://casadellibro.es", new String[]{"libros","lectura","ocio"},"Libros y más cosas"),
      new Item("La web del gamer","http://gamers.es", new String[]{"juegos","ordenadores","ocio"},"Todo sobre video juegos"),
      new Item("My computer","http://computerall.es", new String[]{"informática","ordenadores"},"Ordenadores al mejor precio"),
      new Item("Fnac","http://fnac.es", new String[]{"juegos","ordenadores","libros"},"Bienvenido al mundo del ocio y la cultura"),
      new Item("Todo pelis","http://filmers.es", new String[]{"cine","peliculas","ocio"},"Entra en el mundo del cine"));
      
   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
      String tema=request.getParameter("tema");
    
      response.setContentType("text/html");
      PrintWriter out=response.getWriter();
      out.println("<html><body>");
		
      //recorremos todos los item de la lista
      for(Item item:items) {
         //para cada item, recorremos su array de temas
         //y miramos si alguno coincide con el tema recibido
         for(String dato:item.getSeo()) {
            if(dato.equals(tema)) {
               out.println("<h2><a href='"+item.getUrl()+"'>"+item.getTitulo()+"</a><br/>");
            }
         }
      }
      out.println("</body></html>");	
   }
}
```

Al ejecutar la aplicación tenemos 

![04-02-ej](images/04-02-ej.png)
![04-03-ej](images/04-03-ej.png)
![04-04-ej](images/04-04-ej.png)

Si métemos algún tema que no existe nos devolverá una pantalla en blanco ya veremos más adelante como solucionar esto.

![04-05-ej](images/04-05-ej.png)
![04-06-ej](images/04-06-ej.png)


Existe una forma diferente de hacer la búsqueda usando Streams (debemos cambiar en `buscador.html` el `action="BuscadorStreams"` ):

`BuscadorStreams`

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Arrays;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import model.Item;

/**
 * Servlet implementation class Buscador
 */
@WebServlet("/BuscadorStreams")
public class BuscadorStreams extends HttpServlet {
	
   private static final long serialVersionUID = 1L;
	
      List<Item> items=List.of(
         new Item("Casa del libro","http://casadellibro.es", new String[]{"libros","lectura","ocio"},"Libros y más cosas"),
         new Item("La web del gamer","http://gamers.es", new String[]{"juegos","ordenadores","ocio"},"Todo sobre video juegos"),
         new Item("My computer","http://computerall.es", new String[]{"informática","ordenadores"},"Ordenadores al mejor precio"),
         new Item("Fnac","http://fnac.es", new String[]{"juegos","ordenadores","libros"},"Bienvenido al mundo del ocio y la cultura"),
         new Item("Todo pelis","http://filmers.es", new String[]{"cine","peliculas","ocio"},"Entra en el mundo del cine"));		
			
   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
      String tema=request.getParameter("tema");
		
      response.setContentType("text/html");
      PrintWriter out=response.getWriter();
      out.println("<html><body>");
		
      //solución utilizando programación funcional
      items.stream()
         .filter(item->Arrays.stream(item.getSeo())
                           .anyMatch(t->t.equals(tema))
         ) //Convierto el array getSeo() en un Stream y a eso le aplico el anyMatch todo eso es lo que estoy filtrando
	 .forEach(item->out.println("<h2><a href='"+item.getUrl()+"'>"+item.getTitulo()+"</a><br/>"));
		
      out.println("</body></html>");
   }

}
```

![02-12](images/02-12.png)

### :computer: Ejemplo `05_texto`

Vamos a realizar una aplicacíon que pase parámetros mediante la URL.

![05-00-ej](images/05-00-ej.png)


`opciones.html`

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Parámetros por URL</title>
</head>
<body>
   <a href="Texto?size=6">Pequeño</a><br/>
   <a href="Texto?size=3">Medio</a><br/>
   <a href="Texto?size=1">Grande</a><br/>
</body>
</html>
```

`Texto.java`

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;


@WebServlet("/Texto")
public class Texto extends HttpServlet {
   private static final long serialVersionUID = 1L;

   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
      String size = request.getParameter("size");

      //construimos la página usando entrada-salida Java
      PrintWriter out = response.getWriter();
      out.println("<html><body>");
      out.println("<h1>Resultados</h1>");
      out.println("<h" + size + ">Esto es un Texto</html>");
      out.println("</body></html>");
   }

}
```

Vamos a probar la apicación.

![05-01-ej](images/05-01-ej.png)

Según el enlace seleccionado se pinta el texto de un tamaño u otro, observese en el URL es paso del parámetro.

![05-02-ej](images/05-02-ej.png)
![05-03-ej](images/05-03-ej.png)
![05-04-ej](images/05-04-ej.png)

## Transferencia de Peticiones

![02-13](images/02-13.png)
![02-19](images/02-19.png)
![02-20](images/02-20.png)
![02-21](images/02-21.png)
![02-22](images/02-22.png)

### :computer: Ejemplo `04_buscador`

![04-09-ej](images/04-09-ej.png)

Como vimos en el ejemplo `04_buscador` cuando no localizabamos información de algún tema nos mostraba una pantalla en blanco, vamos a usar la Transferencia de Peticiones para pintar una pantalla cuando no existan datos. Para lograr esto necesitamos modificar el Servlet `Buscador` y añadir un nuevo Servlet `Error`.


`Buscador.java`

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import model.Item;

@WebServlet("/Buscador")
public class Buscador extends HttpServlet {
	
   private static final long serialVersionUID = 1L;
	
   List<Item> items=List.of(
      new Item("Casa del libro","http://casadellibro.es", new String[]{"libros","lectura","ocio"},"Libros y más cosas"),
      new Item("La web del gamer","http://gamers.es", new String[]{"juegos","ordenadores","ocio"},"Todo sobre video juegos"),
      new Item("My computer","http://computerall.es", new String[]{"informática","ordenadores"},"Ordenadores al mejor precio"),
      new Item("Fnac","http://fnac.es", new String[]{"juegos","ordenadores","libros"},"Bienvenido al mundo del ocio y la cultura"),
      new Item("Todo pelis","http://filmers.es", new String[]{"cine","peliculas","ocio"},"Entra en el mundo del cine"));
      
   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
      String tema=request.getParameter("tema");
    
      response.setContentType("text/html");
      PrintWriter out=response.getWriter();
      out.println("<html><body>");
		
      if(comprobar(tema)) {
         //recorremos todos los item de la lista
         for(Item item:items) {
            //para cada item, recorremos su array de temas
            //y miramos si alguno coincide con el tema recibido
            for(String dato:item.getSeo()) {
               if(dato.equals(tema)) {
                  out.println("<h2><a href='"+item.getUrl()+"'>"+item.getTitulo()+"</a><br/>");
               }
            }
         }
         out.println("</body></html>");
      }	else {
         //transferimos el control a otro servlet 
         //encargado de generar una página de error
         RequestDispatcher dispatcher=request.getRequestDispatcher("Error");
         dispatcher.forward(request, response);
      }
   }
	
   private boolean comprobar(String palabra) {
      for(Item item:items) {
         for(String dato:item.getSeo()) {
            if(dato.equals(palabra)) {
               return true;
            }
         }
      }
      return false;
   }

}
```

El nuevo Servlet es `Error`:

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/Error")
public class Error extends HttpServlet {
   private static final long serialVersionUID = 1L;

   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
      //los parámetros que le llegaron al servlet de origen
      //están disponibles también en el destino
      String tema=request.getParameter("tema");
		
      response.setContentType("text/html");
      PrintWriter out=response.getWriter();
		
      out.println("<html><body>");
      out.println("<h2>No hay entradas para el tema "+tema+"</h2>");
      out.println("<a href='buscador.html'>Volver</a>");
      out.println("</body></html>");
   }

}
```

Al ejecutar la aplicación tenemos 

![04-10-ej](images/04-10-ej.png)
![04-11-ej](images/04-11-ej.png)


### :computer: Ejemplo `06_buscador_login`

Partiendo del proyecto `04_buscador` vamos a realizar una aplicacíon que permita logearse y si lo hacemos podamos usar el buscador y si no que nos lo indique, el esquema de la aplicación se ve en la imagen.

![06-01-ej](images/06-01-ej.png)

Por lo que vemos en la imagen vamos a necesitar añadir una página `login.html` y dos Servlets el de autenticar `Login` y uno `NoAutenticado` para mostrar una página que indique que no se pudo logear.

![06-02-ej](images/06-02-ej.png)

`login.html`

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>
   <div align="center">
      <h1>Página de autenticación</h1>
      <form action="Login" method="post">
         Usuario:<input type="text" name="usuario"/><br/><br/>
         Contraseña:<input type="password" name="password"/><br/><br/>
         <input type="submit" value="Entrar"/>
      </form>
   </div>
</body>
</html>
```

Servlet `Login`

```java
package servlets;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/Login")
public class Login extends HttpServlet {
	
   private static final long serialVersionUID = 1L;
   private static final String user="admin";
   private static final String pass="admin";
	
   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
      String usuario=request.getParameter("usuario");
      String password=request.getParameter("password");
		
      RequestDispatcher dispatcher;
		
      if(usuario.equals(user)&&password.equals(pass)) {
         dispatcher=request.getRequestDispatcher("buscador.html");
      } else {
         dispatcher=request.getRequestDispatcher("NoAutenticado");
      }
      dispatcher.forward(request, response);
   }
}
```

Observe como con el `dispatcher` podemos llamar tanto a otro Servet o a una página HTML o JSP.

Servlet `NoAutenticado`

```java
package servlets;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/NoAutenticado")
public class NoAutenticado extends HttpServlet {
   private static final long serialVersionUID = 1L;

   protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
      //los parámetros que le llegaron al servlet de origen
      //están disponibles tambián en el destino
      String user=request.getParameter("usuario");
		
      response.setContentType("text/html");
      response.setCharacterEncoding("UTF-8");
		
      PrintWriter out=response.getWriter();
		
      out.println("<html><body>");
      out.println("<h2>El usuario " + user + " no está autenticado</h2>");
      out.println("<a href='login.html'>Volver</a>");
      out.println("</body></html>");
   }
}
```

Si probamos la aplicación tenemos:

![06-03-ej](images/06-03-ej.png)
![06-04-ej](images/06-04-ej.png)

Si ingresamos datos no válidos nos lo indica.

![06-05-ej](images/06-05-ej.png)
![06-06-ej](images/06-06-ej.png)

Si ingresamos datos correctos nos permite acceder al Buscador.


## Mantenimiento de datos en la aplicación

![02-23](images/02-23.png)
![02-24](images/02-24.png)

## Atributos de Petición

![02-25](images/02-25.png)
![02-26](images/02-26.png)
![02-27](images/02-27.png)

## Atributos de Sesión

![02-28](images/02-28.png)
![02-29](images/02-29.png)
![02-30](images/02-30.png)
![02-31](images/02-31.png)

## Atributos de Aplicación

![02-32](images/02-32.png)
![02-33](images/02-33.png)
![02-34](images/02-34.png)
![02-35](images/02-35.png)

## Cookies

![02-36](images/02-36.png)
![02-37](images/02-37.png)
![02-38](images/02-38.png)
![02-39](images/02-39.png)
![02-40](images/02-40.png)

## Eventos de Aplicación 

![02-41](images/02-41.png)
![02-32](images/02-42.png)
![02-43](images/02-43.png)
![02-44](images/02-44.png)

## Java Server Pages

![03-01](images/03-01.png)
![03-02](images/03-02.png)
![03-03](images/03-03.png)
![03-04](images/03-04.png)

## Componentes de una Página JSP

![03-05](images/03-05.png)
![03-06](images/03-06.png)
![03-07](images/03-07.png)
![03-08](images/03-08.png)

## Directivas JSP

![03-09](images/03-09.png)
![03-10](images/03-10.png)
![03-11](images/03-11.png)
![03-12](images/03-12.png)

## Acciones Implícitas JSP

![03-13](images/03-13.png)
![03-14](images/03-14.png)
![03-15](images/03-15.png)

## Integración Servlets - JSP

![03-16](images/03-16.png)
![03-17](images/03-17.png)

## El Lenguaje de Expresiones EL

![03-18](images/03-18.png)
![03-19](images/03-19.png)
![03-20](images/03-20.png)
![03-21](images/03-21.png)
![03-22](images/03-22.png)
![03-23](images/03-23.png)

## La Librería de Acciones JSTL

![03-24](images/03-24.png)
![03-25](images/03-25.png)
![03-26](images/03-26.png)
![03-27](images/03-27.png)

## Principales Acciones JSTL

![03-28](images/03-28.png)
![03-29](images/03-29.png)
![03-30](images/03-30.png)
![03-31](images/03-31.png)
![03-32](images/03-32.png)
![03-33](images/03-33.png)
![03-34](images/03-34.png)
![03-35](images/03-35.png)
