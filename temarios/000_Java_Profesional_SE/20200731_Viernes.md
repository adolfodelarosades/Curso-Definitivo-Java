# 20200731 Viernes

## Comunicacion entre Aplicaciones Java - SOCKETS

En esta lección vamos a ver el intercambio de datos entre aplicaciones Java.

<img src="images/20200731-1.jpg">

<img src="images/20200731-2.jpg">

Aquí usamos el protocolo **TCP/IP**.

Para realizar este tipo de aplicaciones se siguen básicamente dos pasos:

1. Crear conexión entre las aplicaciones.
2. Intercambio de datos mediante operaciones I/O.

Para hacer estos dos pasos se usan dos paquetes.

* [java.net](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/net/package-summary.html)
* [java.io](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/io/package-summary.html)

Para realizar esta conexión usamos ***Sockets*** que permiten engancharme con objetos remotos.

<img src="images/20200731-3.png">

### Class `Socket`

[Class `Socket`](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/net/Socket.html)

<img src="images/20200731-4.png">

Tenemos el Constructor

`Socket(String host, int port)`
		
Crea un stream socket(socket de flujo) y lo conecta al host y número de puerto especificados.

Tenemos varios métodos en la clase `Socket`.

<img src="images/20200731-5.png">

Siendo unos de los más utilizados:

* `InputStream	getInputStream()`
* `OutputStream	getOutputStream()`

### :computer: `000-067_ejemplo_cliente_socket`

Esta es una aplicación muy sencilla donde creamos una aplicación cliente que trata de conectarse con la página `www.oracle.com` esperando la respuesta que nos mande.

*`Test`*

```java
package principal;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.Socket;
import java.net.UnknownHostException;

public class Test {

   public static void main(String[] args) {
      try {
         Socket sc= new Socket("www.oracle.com", 80);//80 Puerto Web
         InputStream is = sc.getInputStream();
         BufferedReader bf = new BufferedReader(new InputStreamReader(is));
			
         System.out.println("Conectando a Oracle...\n");
         String linea;
         while((linea=bf.readLine())!= null) {
            System.out.println(linea);
         }
         System.out.println("\nTermino Conección a Oracle");
         sc.close();
      } catch (UnknownHostException e) {
         e.printStackTrace();
      } catch (IOException e) {
         e.printStackTrace();
      }
   }
}
```

<img src="images/20200731-6.png">

## Aplicación Servidor en Java

Clase [ServerSocket](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/net/ServerSocket.html)

Constructores:

* `ServerSocket()` Crea un socket de servidor independiente.
* `ServerSocket(int port)` Crea un socket de servidor, vinculado al puerto especificado.
* `ServerSocket(int port, int backlog)` Crea un socket de servidor y lo vincula al número de puerto local especificado, con el retraso especificado.
* `ServerSocket(int port, int backlog, InetAddress bindAddr)` Cree un servidor con el puerto especificado, escuche el retraso y la dirección IP local para vincularse.
* `ServerSocket(SocketImpl impl)` Crea un socket de servidor con un SocketImpl especificado por el usuario.

Métodos:

* Socket `accept()` Escucha para que se establezca una conexión a este socket y la acepta.		

### REPASAR LAS SIGUIENTES CLASES

Usadas para pasar cadenas o para pasar objetos.

* [`PrintStream`](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/io/PrintStream.html)
* [`BufferedReader`](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/io/BufferedReader.html)
* [`InputStreamReader`](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/io/InputStreamReader.html)
* [`[ObjectOutputStream`](https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/io/ObjectOutputStream.html)


### :computer: `000-068_ejemplo_comunicacion`

<img src="images/20200731-7.png">

Aplicación que nos permite una interacción de un Cliente y el Servidor.
El cliente manda datos y el servidor los regresa.
Puedo enviar cadenas
Puedo enviar un objeto
Puedo enviar un objeto Persona
Serializar Persona.

*`Persona`*

```java
package model;

import java.io.Serializable;

public class Persona implements Serializable {

   private static final long serialVersionUID = 1L;
   private String nombre;
   private int edad;

   public Persona(String nombre, int edad) {
      super();
      this.nombre = nombre;
      this.edad = edad;
   }

   public String getNombre() {
      return nombre;
   }

   public void setNombre(String nombre) {
      this.nombre = nombre;
   }

   public int getEdad() {
      return edad;
   }

   public void setEdad(int edad) {
      this.edad = edad;
   }

}
```

*`ClienteSaludo`*

```java
package cliente;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.PrintStream;
import java.net.Socket;

import model.Persona;

public class ClienteSaludo {

   public static void main(String[] args) {
      try (Socket sc = new Socket("localhost", 10000);) {

         PrintStream out = new PrintStream(sc.getOutputStream());
         out.println("profe");
         // BufferedReader bf = new BufferedReader(new
         // InputStreamReader(sc.getInputStream()));
         // Para leer Objetos
         ObjectInputStream ob = new ObjectInputStream(sc.getInputStream());
         Persona p = (Persona) ob.readObject();
         System.out.println("Soy " + p.getNombre() + " " + p.getEdad());

         // String dato = bf.readLine();
         // System.out.println("El servidor me envía: " + dato);

      } catch (IOException ex) {
         ex.printStackTrace();
      } catch (ClassNotFoundException e) {
         e.printStackTrace();
      }
   }
}
```

*`HiloAtencionCliente`*

```java
package servidor;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.ObjectOutputStream;
import java.io.PrintStream;
import java.net.Socket;

import model.Persona;

public class HiloAtencionCliente implements Runnable {
	
   private Socket socket;
   public HiloAtencionCliente(Socket socket) {
      this.socket = socket;
   }

   @Override
   public void run() {
      try(ObjectOutputStream out= new ObjectOutputStream(socket.getOutputStream());
          BufferedReader bf = new BufferedReader(new InputStreamReader(socket.getInputStream()));){
         String nombre = bf.readLine();
	 Persona persona = new Persona (nombre, 30);
	 out.writeObject(persona);
	 //out.println("Saludo desde el servidor cliente " + nombre);
      }catch (IOException ex) {
         ex.printStackTrace();
      }finally {
         try {
            socket.close();
         }catch(IOException e) {
            e.printStackTrace();
         }
      }
   }
}
```

*`ServidorSaludo`*

```java
package servidor;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ServidorSaludo {

   public static void main(String[] args) {
      System.out.println("Esperando llamadas..."); 
      ExecutorService service = Executors.newCachedThreadPool();
      try(ServerSocket server = new ServerSocket(10000);){
	    	
         while(true) {
            Socket sc = server.accept();
            System.out.println("Llama recibida!");
            service.submit(new HiloAtencionCliente(sc));
         }
      }catch(IOException ex) {
         ex.printStackTrace();
      }
   }
}
```


