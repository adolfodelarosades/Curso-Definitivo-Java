# 20200730 Jueves

### :computer: `000-064_agenda_bd_v2`

Vamos a modificar el proyecto para meter los datos de conexión en un archivo JSON de configuración. 

<img src="images/20200730-01.png">

**Model**

*`Contacto`* (Igual)

```java
package model;

public class Contacto {
	
   private int idContacto;
   private String nombre;
   private String email;
   private int edad;
	
   public Contacto(String nombre, String email, int edad) {
      super();
      this.nombre = nombre;
      this.email = email;
      this.edad = edad;
   }
	
   public Contacto(int idContacto, String nombre, String email, int edad) {
      super();
      this.idContacto = idContacto;
      this.nombre = nombre;
      this.email = email;
      this.edad = edad;
   }

   public int getIdContacto() {
      return idContacto;
   }

   public void setIdContacto(int idContacto) {
      this.idContacto = idContacto;
   }

   public String getNombre() {
      return nombre;
   }

   public void setNombre(String nombre) {
      this.nombre = nombre;
   }

   public String getEmail() {
      return email;
   }

   public void setEmail(String email) {
      this.email = email;
   }

   public int getEdad() {
      return edad;
   }

   public void setEdad(int edad) {
      this.edad = edad;
   }
}
```

**Service**

*`Datos`* (**Cambio**)

```java
package service;

import java.io.FileNotFoundException;
import java.io.FileReader;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

import com.google.gson.JsonIOException;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.JsonSyntaxException;

public class Datos  {
   static String driver;
   static String cadenaConexion;
   static String user;
   static String password;
   static String FILE="config.json";
   static {
      //carga del driver
      try {
         cargarPropiedades();
         Class.forName(driver);
      } catch (ClassNotFoundException e) {
         e.printStackTrace();
      } catch (JsonIOException e) {
         e.printStackTrace();
		  } catch (JsonSyntaxException e) {
         e.printStackTrace();
      } catch (FileNotFoundException e) {
         e.printStackTrace();
		  }
   }
	
   public static Connection getConnection() throws SQLException {
      return DriverManager.getConnection(cadenaConexion, user, password);
   }

   private static void cargarPropiedades() throws JsonIOException, JsonSyntaxException, FileNotFoundException {
      JsonObject conn = JsonParser.parseReader(new FileReader(FILE)).getAsJsonObject();
      driver 		    = conn.get("driver").getAsString();
      cadenaConexion 	= conn.get("cadenaConexion").getAsString();
      user 		    = conn.get("user").getAsString();
      password 		= conn.get("password").getAsString();
   }
}
```

*`ContactoService`* (Igual)

```java
package service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import model.Contacto;

public class ContactoService {
	
   public boolean agregarContacto(Contacto contacto) {
		
      //Conexión de la base de datos.
      try(Connection con = Datos.getConnection()) {
         		
         /* USANDO PreparedStatement*/
         String sql= "INSERT INTO contactos(nombre, email, edad) values(?,?,?)";
         PreparedStatement st = con.prepareStatement(sql);
         st.setString(1, contacto.getNombre());
         st.setString(2, contacto.getEmail());
         st.setInt(3, contacto.getEdad());
         st.execute();
         return true;
			
      } catch (SQLException e) {
         e.printStackTrace();
      }
      return false;
   }
	
   public static boolean borrarContacto(String email) {
      try(Connection con = Datos.getConnection()) {
    		
         String sql = "DELETE FROM contactos WHERE email = ?";
         PreparedStatement st = con.prepareStatement(sql);
         st.setString(1, email);
         //st.execute();
         //return true;
         return st.executeUpdate()>0;
		   
      } catch (SQLException e) {
         e.printStackTrace();
      }
      return false;
   }
    
   public Contacto buscarContacto(String email) {
    	
      try(Connection con = Datos.getConnection()) {
    	   
         String sql = "SELECT * FROM contactos WHERE email = ?";
         PreparedStatement pst = con.prepareStatement(sql);
         pst.setString(1, email);
         ResultSet rs = pst.executeQuery(); //Aquí no se le manda el sql por que ya esta en el pst
 		   
         if(rs.next()) {
            return new Contacto(rs.getString("nombre"),rs.getString("email"),rs.getInt("edad"));
         }
      } catch (SQLException e) {
         e.printStackTrace();
      }
      return null;
   }
    
   public List<Contacto> leerContactos() {
	   
      try(Connection con = Datos.getConnection()) {
         List<Contacto> lista = new ArrayList<>();
	   
         String sql = "SELECT * FROM contactos";
         Statement st = con.createStatement();
         ResultSet rs = st.executeQuery(sql);
		
         while(rs.next()) {
            lista.add(new Contacto(rs.getString("nombre"),rs.getString("email"),rs.getInt("edad")));
         }
         return lista;
      } catch (SQLException e) {
         e.printStackTrace();
      }
      return null;
   }
}
```

**Principal**

*`TestBD`* (Igual)

```java
package principal;

import java.util.List;
import java.util.Scanner;

import model.Contacto;
import service.ContactoService;

public class TestBD {

   public static void main(String[] args) {
		
      Scanner sc = new Scanner(System.in);
      int opcion = 0;
			
      do {
         menu();
         System.out.println("\nOpción:");
         opcion = Integer.parseInt(sc.nextLine());
         switch (opcion) {
            case 1: {
               agregarContacto();
	             break;
            }
            case 2: {
               eliminarContacto();
               break;
            }
            case 3: {
               buscarContacto();
               break;
            }
            case 4: {
               mostrarContactos();
               break;
            }
            case 5: {
               System.out.println("ADIOS!!!");
               break;
            }
            default:
               System.out.println("Opción no valida");
            }
         }while(opcion != 5);
      }
	
      private static void  menu() {
         System.out.println("\n***** Menú *****");
         System.out.println("1. Agregar Contacto");
         System.out.println("2. Eliminar Contacto");
         System.out.println("3. Buscar Contacto");
         System.out.println("4. Mostrar Contacto");
         System.out.println("5. Salir");
      }
	
      private static void  agregarContacto() {	
         String nombre;
         String email;
         int edad;
         Scanner sc = new Scanner(System.in);
         ContactoService cs = new ContactoService();
		
         System.out.println("***** Agregar Contacto *****");
         System.out.println("Inserta el nombre:");
         nombre = sc.nextLine();
         System.out.println("Inserta el email:");
         email = sc.nextLine();
         System.out.println("Insertar Edad");
         edad = Integer.parseInt(sc.nextLine());
		
         Contacto contacto = new Contacto(nombre, email, edad);
         if (cs.agregarContacto(contacto)) {
            System.out.println("Contacto Agregado");
         }else {
            System.out.println("No se agrego el Contacto");
         }
      }
	
      private static void  eliminarContacto() {
         String email;
         Scanner sc = new Scanner(System.in);
         ContactoService cs = new ContactoService();
         System.out.println("***** Agregar Contacto *****");
         System.out.println("Inserta email:");
         email = sc.nextLine();
		
         if(cs.borrarContacto(email)) {
            System.out.println("Contacto eliminado");
         }else {
            System.out.println("No se pudo eliminar el Contacto con email " + email);
         }	
      }
	
      private static void  buscarContacto() {
         String email;
         Scanner sc = new Scanner(System.in);
         ContactoService cs = new ContactoService();
         System.out.println("***** Buscar Contacto *****");
         System.out.println("Inserta email:");
         email = sc.nextLine();
		
         Contacto contacto = cs.buscarContacto(email);
		
         if(contacto != null) {
            System.out.println(contacto.getNombre() + " " + contacto.getEmail() + " " + contacto.getEdad());
         }else {
            System.out.println("No se pudo localizar el Contacto con email " + email);
         }	
      }

      private static void  mostrarContactos() {
         ContactoService cs = new ContactoService();
    	
         List<Contacto> contactos = cs.leerContactos();
    	
         System.out.println("***** Lista Contacto *****");
         contactos
            .forEach(contacto -> System.out.println(contacto.getNombre() + " " + contacto.getEmail() + " " + contacto.getEdad()));	
      }
   }
}
```

*`config.json`* (Nuevo)

```html
{
"driver":"com.mysql.cj.jdbc.Driver",
"cadenaConexion":"jdbc:mysql://localhost:3306/miscontactos?serverTimezone=UTC",
"user":"root",
"password":"root"
}
```

*`pom.xml`* (Nuevo)

```html
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
   <groupId>000-063_agenda_bd_v1</groupId>
   <artifactId>000-063_agenda_bd_v1</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <build>
      <sourceDirectory>src</sourceDirectory>
      <plugins>
	 <plugin>
	    <artifactId>maven-compiler-plugin</artifactId>
	    <version>3.8.1</version>
	    <configuration>
	       <release>14</release>
	    </configuration>
	 </plugin>
      </plugins>
   </build>
   <dependencies>
      <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
      <dependency>
         <groupId>mysql</groupId>
	 <artifactId>mysql-connector-java</artifactId>
	 <version>8.0.19</version>
      </dependency>
      <dependency>
	 <groupId>com.google.code.gson</groupId>
	 <artifactId>gson</artifactId>
	 <version>2.8.6</version>
      </dependency>
   </dependencies>
</project>
```

<img src="images/20200730-02.png">

<img src="images/20200730-03.png">

<img src="images/20200730-04.png">

